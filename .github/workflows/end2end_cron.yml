---
name: End-to-End Tests

on:
    # because these run on the self-hosted gpu instance which does single threaded
    # job processing we explicitly don't trigger on pushes or PRs to develop.
    # also because `schedule` only builds on master that's of little use to us
    # presently
    push:
        branches:
            - master
            # TODO remove 1422-.. branch when testing complete
            - 1422-re-enable-end-to-end-ci-tests
    pull_request:
        branches:
            - master
            # TODO remove 1422-.. branch when testing complete
            - 1422-re-enable-end-to-end-ci-tests
    workflow_dispatch:

jobs:
    docker-build:
        name: Build Docker Image
        runs-on: [self-hosted, gpu]
        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 0
            - uses: actions/setup-python@v2
              with:
                  python-version: "3.7"
            - name: Build Docker
              id: docker-build
              run: |
                  pip install -r requirements.txt
                  pip install .
                  python docker/build.py all
            - name: get imageTag version
              id: image-version
              run: echo "::set-output imageTag=$(python setup.py --version | sed -e 's/dev[0-9][0-9]*+//' -e 's/\.d[0-9][0-9]*$//')"
            - name: show imageTag --version
              run: echo ${{ steps.image-version.outputs.imageTag }}
        outputs:
            imageTag: ${{ steps.image-version.outputs.imageTag }}
    docker-pytorch-end2end:
        name: Docker Torch End2End
        needs: docker-build
        runs-on: [self-hosted, gpu]
        steps:
            - name: Run Tests Torch Docker
              run: |
                  imageTag=$(python setup.py --version | sed -e 's/dev[0-9][0-9]*+//' -e 's/\.d[0-9][0-9]*$//')
                  imageName=twosixarmory/pytorch:$imageTag
                  echo "Running Tests with Image -> $imageName"
                  docker run -w /armory-repo/ $imageName pytest -vs -m "not docker_required and end_to_end" ./tests/
    docker-tf2-end2end:
        name: Docker TF2 End2End
        needs: docker-build
        runs-on: [self-hosted, gpu]
        steps:
            - name: Run Tests TF2 Docker
              run: |
                  imageTag=$(python setup.py --version | sed -e 's/dev[0-9][0-9]*+//' -e 's/\.d[0-9][0-9]*$//')
                  imageName=twosixarmory/tf2:$imageTag
                  echo "Running Tests with Image -> $imageName"
                  docker run -w /armory-repo/ $imageName pytest -vs -m "not docker_required and end_to_end" ./tests/
    docker-deepspeech-end2end:
        name: Docker Deepspeech End2End
        needs: docker-build
        runs-on: [self-hosted, gpu]
        steps:
            - name: Run Tests Deepspeech Docker
              run: |
                  imageTag=$(python setup.py --version | sed -e 's/dev[0-9][0-9]*+//' -e 's/\.d[0-9][0-9]*$//')
                  imageName=twosixarmory/pytorch-deepspeech:$imageTag
                  echo "Running Tests with Image -> $imageName"
                  docker run -w /armory-repo/ $imageName pytest -vs -m "not docker_required and end_to_end" ./tests/

    # TODO: the until time might need to be reduced depending on measured usage
    docker-prune:
        name: remove docker images older than one week
        needs:
            [
                docker-pytorch-end2end,
                docker-tf2-end2end,
                docker-deepspeech-end2end,
            ]
        runs-on: [self-hosted, gpu]
        steps:
            - run: docker image prune -a --force --filter "until=168h"
